<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Techno Verse • #merc-guild</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --metal-1:#595f62; --metal-2:#8b9497; --metal-3:#2b2f31; --acid:#17ff7a; --amber:#f2c26b; --red:#ff4d4d; --screen-glow: rgba(23,255,122,0.25); --glass-blur:8px; --glass-sat:1.4;
    }
    html,body{height:100%}
    body{ margin:0; min-height:100%; background:#0a0d10; color:#cfd8dc; font-family:'Share Tech Mono', monospace; background-image: radial-gradient(1200px 500px at 50% 0%, #0c1116 0%, #06080a 60%, #040607 100%), radial-gradient(50% 100% at 50% 120%, #0f1a1f 0%, transparent 80%); padding-top:0; }
    .frame{ position:relative; width:min(1200px,96vw); margin:0 auto 18px; padding:18px; border-radius:22px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(0,0,0,0.1)), radial-gradient(200% 120% at 50% -20%, rgba(255,255,255,0.06), transparent 55%), repeating-linear-gradient(90deg, #777 0 1px, #6a6a6a 1px 2px), linear-gradient(180deg, var(--metal-2), var(--metal-1) 30%, #4b5053 60%, #42484a 100%); box-shadow: inset 0 0 0 2px #202426, inset 0 0 0 4px #101214, 0 30px 80px rgba(0,0,0,0.55), 0 6px 16px rgba(0,0,0,0.6); outline:1px solid #0f1316; filter:contrast(1.02) saturate(1.05); }
    .frame:before{content:""; position:absolute; inset:10px; padding:10px; border-radius:18px; background:linear-gradient(145deg, rgba(0,0,0,0.4), rgba(255,255,255,0.05) 40%, rgba(0,0,0,0.45)); -webkit-mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000); mask: linear-gradient(#000,#000) content-box, linear-gradient(#000,#000); -webkit-mask-composite:xor; mask-composite:exclude; pointer-events:none; }
    .frame:after{content:""; position:absolute; inset:0; border-radius:22px; pointer-events:none; background: radial-gradient(circle at 26px 26px, #a7b0b4 0 4px, #51585b 4px 6px, transparent 6px), radial-gradient(circle at calc(100% - 26px) 26px, #a7b0b4 0 4px, #51585b 4px 6px, transparent 6px), radial-gradient(circle at 26px calc(100% - 26px), #a7b0b4 0 4px, #51585b 4px 6px, transparent 6px), radial-gradient(circle at calc(100% - 26px) calc(100% - 26px), #a7b0b4 0 4px, #51585b 4px 6px, transparent 6px); mix-blend-mode:overlay; }
    .frame.topbar{ position:sticky; top:0; z-index:1000; width:100vw; max-width:none; border-radius:0; padding-left:0; padding-right:0; margin:0 0 18px; }
    .frame.topbar:before, .frame.topbar:after{ border-radius:0; }
    nav.navbar{ width:100%; max-width:min(1200px,96vw); margin:0 auto; padding:14px; border-radius:16px; isolation:isolate; background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(0,0,0,0.35)), radial-gradient(130% 220% at -10% 0%, rgba(255,255,255,0.08), transparent 50%), linear-gradient(180deg, #6b7376, #3e4649); box-shadow: inset 0 0 0 1px #0e1214, inset 0 -2px 12px rgba(0,0,0,0.35), 0 12px 24px rgba(0,0,0,0.3); display:grid; grid-template-columns: auto 1fr auto; grid-template-rows:auto auto; gap:12px; align-items:center; }
    .tools{ grid-column:3; grid-row:1; display:flex; gap:8px; align-items:center; justify-self:end; }
    .brand{ display:flex; align-items:center; height:54px; padding:0 14px; border-radius:10px; text-decoration:none; border:1px solid rgba(23,255,122,0.25); background: linear-gradient(180deg, rgba(23,255,122,0.06), rgba(0,0,0,0.25)); box-shadow: inset 0 0 0 1px rgba(23,255,122,0.25); }
    .brand span{ font-family:'Orbitron',sans-serif; font-weight:700; letter-spacing:0.14em; background:linear-gradient(90deg,#66ffe0,#17ff7a,#b3ff00); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 14px rgba(23,255,122,0.25); }
    .tool{ height:54px; padding:10px 12px; border-radius:10px; border:0; cursor:pointer; background: linear-gradient(180deg, #23302e, #0d1211); color:var(--acid); font-family:'Share Tech Mono', monospace; }
    .crt{ grid-column:2; grid-row:1; justify-self:center; position:relative; width:420px; height:76px; border-radius:10px; padding:10px 12px; overflow:hidden; background: radial-gradient(120% 180% at 50% 40%, rgba(17,255,122,0.18), rgba(17,255,122,0.06) 60%, rgba(0,0,0,0.05) 100%), #07140d; color:var(--acid); font-size:14px; box-shadow: inset 0 0 0 1px rgba(23,255,122,0.35), inset 0 0 22px var(--screen-glow), 0 0 24px rgba(17,255,122,0.15); }
    .crt:before{ content:""; position:absolute; inset:0; background:repeating-linear-gradient(to bottom, rgba(0,0,0,.2) 0 1px, rgba(0,0,0,0) 1px 3px); opacity:.45; }
    .crt .row{ display:flex; justify-content:space-between; }
    .led{ width:10px; height:10px; border-radius:50%; margin-left:8px; display:inline-block; background: radial-gradient(circle at 30% 30%, #fff, var(--amber) 30%, #aa7b2e 60%, #5a3e12 70%); box-shadow:0 0 8px var(--amber); }
    .btns{ grid-column:1 / -1; grid-row:2; display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }
    .nav-btn{ position:relative; display:flex; align-items:center; justify-content:center; gap:10px; padding:10px 14px; min-width:130px; height:54px; flex:0 0 auto; border:0; border-radius:12px; cursor:pointer; user-select:none; text-decoration: none; font-family:'Orbitron',sans-serif; font-size:12px; color:#d7ffea; background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0.4)), linear-gradient(180deg, #2b3432, #121716); box-shadow: inset 0 0 0 1px #0a0f0e, 0 4px 10px rgba(0,0,0,0.4); }
    .nav-btn:before{ content:""; position:absolute; inset:1px; border-radius:11px; backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)); background: linear-gradient(180deg, rgba(22,44,38,0.55), rgba(8,16,14,0.4)); box-shadow: inset 0 0 0 1px rgba(23,255,122,0.22), inset 0 6px 22px rgba(23,255,122,0.06); pointer-events:none; }
    .nav-btn:hover{ box-shadow: inset 0 0 0 1px #0a0f0e, 0 6px 14px rgba(0,0,0,0.55); transform: translateY(-1px); }
    .nav-btn.active{ outline:1px solid rgba(23,255,122,0.45); }
    .ico{ width:18px; height:18px; display:inline-grid; place-items:center; filter: drop-shadow(0 0 4px rgba(23,255,122,0.5)); }
    .label{ position:relative; z-index:1; text-transform:uppercase; letter-spacing:.09em; font-weight:600; line-height:1; white-space:nowrap; text-shadow: 0 1px 0 rgba(0,0,0,.6), 0 0 10px rgba(23,255,122,.18); -webkit-text-stroke:.25px rgba(0,0,0,.35); }
    .holo-card{ position:relative; border-radius:18px; padding:20px 20px 24px; color:#dff7ff; background: linear-gradient(180deg, rgba(15,45,60,0.45), rgba(10,35,48,0.25)); backdrop-filter: blur(var(--glass-blur)) saturate(var(--glass-sat)); box-shadow: 0 0 0 1px rgba(72,200,255,0.6), inset 0 0 36px rgba(72,200,255,0.2), 0 40px 120px rgba(0,0,0,0.6); overflow:hidden; }
    .holo-card:before{ content:""; position:absolute; inset:-60px; background: radial-gradient(80% 30% at 50% 0%, rgba(72,200,255,0.25), transparent 60%), repeating-linear-gradient(to right, rgba(72,200,255,0.08) 0 1px, rgba(0,0,0,0) 1px 24px), repeating-linear-gradient(to bottom, rgba(72,200,255,0.08) 0 1px, rgba(0,0,0,0) 1px 24px); mix-blend-mode:screen; pointer-events:none; animation: drift 16s linear infinite; }
    @keyframes drift{ 0%{ transform: translateY(-10px);} 100%{ transform: translateY(10px);} }
    .hero-title{ font-family:'Orbitron',sans-serif; text-transform:uppercase; letter-spacing:.14em; font-size:22px; }
    footer.footer .holo-card{ padding:14px 18px; margin-top: 18px; }
    .foot{ display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; }
    .foot a{ color:#aee8ff; text-decoration:none; }
    .foot a:hover{ text-decoration:underline; }

    /* ---- CHANNEL PAGE STYLES ---- */
    .channel-container {
        display: grid;
        grid-template-columns: 1fr 240px;
        gap: 15px;
        height: 70vh;
        min-height: 550px;
    }
    .channel-main {
        display: flex;
        flex-direction: column;
        background: rgba(0,0,0,0.2);
        border-radius: 12px;
        border: 1px solid rgba(23,255,122,0.1);
    }
    .channel-header {
        padding: 15px;
        border-bottom: 1px solid rgba(23,255,122,0.2);
    }
    .channel-header .name { font-family: 'Orbitron', sans-serif; font-size: 1.2em; color: var(--acid); text-shadow: 0 0 8px var(--screen-glow); }
    .channel-header .topic { font-size: 0.9em; opacity: 0.8; margin-top: 4px; }
    
    .message-area { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 12px; }
    .message { display: flex; gap: 10px; }
    .message .sender { font-weight: bold; flex-shrink: 0; width: 120px; text-align: right; color: var(--amber); }
    .message .text { flex-grow: 1; color: #d9e8ef; }
    .message .text .contract { color: var(--red); font-weight: bold; }
    .message .text .lfs { color: #7af8ff; font-weight: bold; }
    
    .channel-input { display: flex; padding: 15px; border-top: 1px solid rgba(23,255,122,0.2); }
    #message-input { flex-grow: 1; background: rgba(0,0,0,0.3); border: 1px solid rgba(23,255,122,0.3); border-radius: 8px; padding: 10px; color: #fff; font-family: 'Share Tech Mono', monospace; }
    #send-button { margin-left: 10px; padding: 10px 20px; background: transparent; border: 1px solid var(--acid); color: var(--acid); border-radius: 8px; cursor: pointer; font-family: 'Orbitron', sans-serif; transition: background 0.2s, color 0.2s; }
    #send-button:hover { background: var(--acid); color: #000; }
    
    .user-list-sidebar { background: rgba(0,0,0,0.2); border-radius: 12px; padding: 10px; overflow-y: auto; border: 1px solid rgba(23,255,122,0.1); display: flex; flex-direction: column; }
    .user-list-header { font-family: 'Orbitron', sans-serif; padding: 5px; margin-bottom: 10px; border-bottom: 1px solid rgba(23,255,122,0.2); text-align: center; }
    .user-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 8px; }
    .user-list li { padding: 4px 8px; border-radius: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.9em; }
    .user-list li::before { content: '●'; font-size: 0.8em; color: var(--acid); }
    
    .message .text .typing-indicator {
      animation: typing-blink 1.2s infinite;
    }
    @keyframes typing-blink {
      50% { opacity: 0.4; }
    }
  </style>
</head>
<body>
  <div class="frame topbar">
    <nav class="navbar">
      <div class="crt"><div class="row"><span>SYSTEM:</span><span>READY</span></div><div class="row"><span>MODE:</span><span>MERC-GUILD</span></div><div class="row"><span>LINK:</span><span>ENCRYPTED<span class="led"></span></span></div></div>
      <div class="btns">
        <a class="nav-btn" href="../../../ops/index.html" data-icon="radar" data-label="Ops"></a>
        <a class="nav-btn" href="../../../map/index.html" data-icon="map" data-label="Map"></a>
        <a class="nav-btn active" href="../../channels.html" data-icon="comms" data-label="Comms"><span class="badge">2</span></a>
        <a class="nav-btn" href="../../../system/index.html" data-icon="gear" data-label="System"></a>
      </div>
      <div class="tools">
        <a href="../../../../index.html" class="brand" id="brandLogo" title="Techno Verse"><span>TECHNO&nbsp;VERSE</span></a>
        <button class="tool" id="themeBtn" title="Themes">THEME</button>
      </div>
    </nav>
  </div>

  <main id="channelWrap">
    <div class="frame">
      <div class="holo-card">
        <div class="channel-container">
          <div class="channel-main">
            <div class="channel-header">
              <div class="name">#merc-guild</div>
              <div class="topic">Official channel for the Mercenary's Guild.</div>
            </div>
            <div class="message-area" id="message-area"></div>
            <form class="channel-input" id="message-form">
              <input type="text" id="message-input" placeholder="Type message..." autocomplete="off">
              <button type="submit" id="send-button">SEND</button>
            </form>
          </div>
          <div class="user-list-sidebar">
            <div class="user-list-header" id="user-count">OPERATORS</div>
            <ul class="user-list" id="user-list"></ul>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <footer class="frame footer">
      <div class="holo-card">
        <div class="foot">
          <div>© 2025 Techno Verse • v0.1.0</div>
          <div class="links"><a href="#">Docs</a> • <a href="#">Privacy</a> • <a href="#">Terms</a></div>
        </div>
      </div>
  </footer>

  <script>
    (function() {
      // --- CORE UI SCRIPT (NAV, THEMES, ETC) ---
      function setupCoreUI() {
        function svg(kind){
          const acid = getComputedStyle(document.documentElement).getPropertyValue('--acid')||'#17ff7a';
          const map = {
            radar:`<svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="${acid}" stroke-width="1.5"><path d="M12 3a9 9 0 1 0 9 9"/><path d="M12 3v9l4 4"/><circle cx="12" cy="12" r="2" fill="currentColor"/></svg>`,
            map:`<svg viewBox='0 0 24 24' width='18' height='18' fill='none' stroke='currentColor' stroke-width='1.5'><path d='M9 6l6-3 6 3v12l-6 3-6-3-6 3V9z'/><path d='M9 6v12'/><path d='M15 3v12'/></svg>`,
            comms:`<svg viewBox='0 0 24 24' width='18' height='18' fill='none' stroke='currentColor' stroke-width='1.5'><path d='M2 8a20 20 0 0 1 20 0'/><path d='M5 12a14 14 0 0 1 14 0'/><path d='M8 16a8 8 0 0 1 8 0'/><circle cx='12' cy='20' r='1.5' fill='currentColor'/></svg>`,
            gear:`<svg viewBox='0 0 24 24' width='18' height='18' fill='none' stroke='currentColor' stroke-width='1.5'><path d='M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z'/><path d='M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06A1.65 1.65 0 0 0 15 19.4a1.65 1.65 0 0 0-1 .6 1.65 1.65 0 0 0-.33 1.82l.02.06a2 2 0 1 1-3.38 0l.02-.06A1.65 1.65 0 0 0 9 19.4 1.65 1.65 0 0 0 7.18 19l-.06.06A2 2 0 1 1 4.29 16.2l.06-.06A1.65 1.65 0 0 0 4.6 15a1.65 1.65 0 0 0-.6-1 1.65 1.65 0 0 0-1.82-.33l-.06.02a2 2 0 1 1 0-3.38l.06.02A1.65 1.65 0 0 0 4.6 9c.08-.39 0-.8-.2-1.15l-.06-.06A2 2 0 1 1 7.18 4.29l.06.06A1.65 1.65 0 0 0 9 4.6c.39-.08.8 0 1.15.2l.06.06A1.65 1.65 0 0 0 12 4.6c.39.08.8 0 1.15-.2l.06-.06A2 2 0 1 1 16.82 7.18l-.06.06c-.2.35-.28.76-.2 1.15a1.65 1.65 0 0 0 1.21 1.21c.39.08.8 0 1.15-.2l.06-.06A2 2 0 1 1 19.71 16.2l-.06-.06c-.35-.2-.76-.28-1.15-.2z'/></svg>`
          };
          return map[kind]||'';
        }
        document.querySelectorAll('.nav-btn').forEach(btn=>{
          const icon = btn.dataset.icon; const label = btn.dataset.label || '';
          let content = '';
          if(icon) content += `<span class="ico">${svg(icon)}</span>`;
          if(label) content += `<span class="label">${label}</span>`;
          const badge = btn.querySelector('.badge');
          btn.innerHTML = content;
          if(badge) btn.appendChild(badge);
        });

        const THEMES = { 'hop-dark': { vars:{'--acid':'#17ff7a'}, bg:['#0a0d10','#040607'] }, /* other themes */ };
        function applyTheme(key){ /* theme logic */ }
        const saved = localStorage.getItem('tkc_theme') || 'hop-dark';
        applyTheme(saved);
      }
      setupCoreUI();

      // --- CHANNEL-SPECIFIC SCRIPT ---
      const messageArea = document.getElementById('message-area');
      const messageForm = document.getElementById('message-form');
      const messageInput = document.getElementById('message-input');
      const userList = document.getElementById('user-list');
      const userCount = document.getElementById('user-count');
      
      const apiKey = ""; // If you want to use models other than gemini-2.5-flash-preview-05-20, provide an API key here. Otherwise, leave this as-is.

      const botPersonas = {
        'Rook': 'You are Rook, a seasoned and serious mercenary commander. You speak in a direct, no-nonsense tone, often about strategy or contracts. Keep your responses to 1-2 short sentences.',
        'Jester': 'You are Jester, a cocky and sarcastic slicer (hacker). You enjoy making witty remarks, showing off your technical knowledge, and using jargon. Keep your responses to 1-2 short sentences.',
        'Warden': 'You are Warden, a calm, professional bounty hunter. You are methodical and a person of few words, focusing on targets and mission success. Keep your responses to 1-2 short sentences.',
        'Blaze': 'You are Blaze, an enthusiastic and slightly reckless heavy weapons expert. You talk excitedly about gear and combat. Keep your responses to 1-2 short sentences.',
        'Shadow': 'You are Shadow, a stealth and infiltration specialist. You are quiet, observant, and speak cryptically about intel and unseen threats. Keep your responses to 1-2 short sentences.',
        'Cipher': 'You are Cipher, a pragmatic gearhead and technician. You talk about ship mods, weapon specs, and repairs. Keep your responses to 1-2 short sentences.',
        'default': 'You are a space mercenary in a futuristic sci-fi world. Respond briefly and stay in character. Keep your responses to 1-2 short sentences.'
      };

      const users = ['Blaze', 'Rook', 'Shadow', 'Jester', 'Oni', 'Vex', 'Kestrel', 'Warden', 'Cipher', 'Nomad', 'Apex', 'Gryphon'];
      const messages = [
        { user: 'Rook', text: '<span class="contract">[CONTRACT]</span> Escort required for a freighter through the Tartarus Belt. High risk, high reward. DM for details.' },
        { user: 'Jester', text: '<span class="lfs">[LFS]</span> Looking for a slicer for a corporate espionage job. Must be discreet.' },
        { user: 'Warden', text: 'Confirmed kill on the bounty for "Red-Eye" Jax. Payment received. Good hunting out there.' },
        { user: 'Shadow', text: 'Anyone have intel on the fortifications at Outpost Delta? Planning a raid.' },
        { user: 'Blaze', text: '<span class="lfs">[LFS]</span> Need a heavy gunner for my crew. Fire support is a must. Share of the loot guaranteed.' },
        { user: 'Cipher', text: 'Just updated my gear. Selling a slightly used plasma repeater, tier 3 mods.' },
      ];
      
      let messageIndex = 0;

      async function getGeminiResponse(persona, userMessage) {
        // --- SIMULATED API RESPONSE FOR CANVAS/TESTING ---
        // NOTE: This section simulates AI responses without an API key.
        // Replace this with the actual API call when deploying.
        console.log(`Simulating Gemini response for persona: ${persona.substring(0, 40)}...`);
        
        const simulatedResponses = {
            'Rook': ["Affirmative.", "Stick to the plan.", "Understood. Keep comms clear.", "Target acquired."],
            'Jester': ["Heh, easy peasy.", "Did you even try turning it off and on again?", "Let me work my magic.", "That's cute."],
            'Warden': ["On it.", "Target is in my sights.", "Payment first.", "No witnesses."],
            'Blaze': ["Let's make some noise!", "Time to light 'em up!", "More dakka!", "Is it time for explosions?"],
            'Shadow': ["...noted.", "They won't see me coming.", "Silence is key.", "From the darkness..."],
            'Cipher': ["I can tune that for you.", "The specs on that are garbage.", "Needs a better power converter.", "Did you check the diagnostics?"],
            'default': ["Copy.", "Roger that.", "On my way."]
        };
        
        const personaKey = Object.keys(botPersonas).find(key => persona === botPersonas[key]);
        const responses = simulatedResponses[personaKey] || simulatedResponses['default'];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];

        return new Promise(resolve => {
            setTimeout(() => {
                resolve(randomResponse);
            }, 600 + Math.random() * 800);
        });
        
        /*
        // --- REAL API CALL (REPLACE SIMULATION WITH THIS) ---
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
        const prompt = `CONTEXT: We are in a sci-fi chatroom for battle-hardened mercenaries. YOUR INSTRUCTIONS: ${persona}. USER SAYS: "${userMessage}"`;

        const payload = {
          contents: [{ parts: [{ text: prompt }] }],
          generationConfig: {
            temperature: 0.9,
            topK: 40,
            maxOutputTokens: 60,
          },
           safetySettings: [
            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" },
          ]
        };

        let response;
        let retries = 3;
        let delay = 1000;

        while (retries > 0) {
          try {
            response = await fetch(apiUrl, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });

            if (response.ok) {
              const result = await response.json();
              const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
              return text?.trim() || "// No response //";
            } else {
              throw new Error(`API request failed with status ${response.status}`);
            }

          } catch (error) {
            console.error(`Attempt failed: ${error.message}. Retrying in ${delay}ms...`);
            retries--;
            if (retries === 0) {
              console.error("Max retries reached. Could not fetch Gemini response.");
              return "// Comms scrambled //";
            }
            await new Promise(res => setTimeout(res, delay));
            delay *= 2; // Exponential backoff
          }
        }
        return "// Connection timed out //";
        */
      }

      function showTypingIndicator(user) {
        const typingDiv = document.createElement('div');
        typingDiv.classList.add('message');
        typingDiv.id = `typing-${user}`;
        typingDiv.innerHTML = `<span class="sender">${user}:</span><span class="text"><span class="typing-indicator">...</span></span>`;
        messageArea.appendChild(typingDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
      }

      function removeTypingIndicator(user) {
        const typingDiv = document.getElementById(`typing-${user}`);
        if (typingDiv) typingDiv.remove();
      }

      function populateUsers() {
          userList.innerHTML = '';
          users.forEach(user => {
              const li = document.createElement('li');
              li.textContent = user;
              userList.appendChild(li);
          });
          userCount.textContent = `OPERATORS (${users.length})`;
      }

      function addMessage(user, text, isUser) {
        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');
        if(isUser) {
           msgDiv.innerHTML = `<span class="sender" style="color: var(--acid)">You:</span><span class="text">${text}</span>`;
        } else {
           msgDiv.innerHTML = `<span class="sender">${user}:</span><span class="text">${text}</span>`;
        }
        messageArea.appendChild(msgDiv);
        messageArea.scrollTop = messageArea.scrollHeight;
      }

      messageForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const text = messageInput.value.trim();
        if (text) {
          addMessage('You', text, true);
          messageInput.value = '';
          
          // Let 1 or 2 bots respond after a short delay
          setTimeout(() => {
            const respondingBots = users.filter(u => u !== 'You').sort(() => 0.5 - Math.random()).slice(0, Math.random() > 0.6 ? 2 : 1);

            respondingBots.forEach(async (botName) => {
              showTypingIndicator(botName);
              const persona = botPersonas[botName] || botPersonas['default'];
              try {
                const responseText = await getGeminiResponse(persona, text);
                removeTypingIndicator(botName);
                addMessage(botName, responseText);
              } catch (error) {
                console.error("Error with bot response:", error);
                removeTypingIndicator(botName);
                addMessage(botName, "// Comms interference... //");
              }
            });
          }, 800 + Math.random() * 1000);
        }
      });
      
      // Initial population
      populateUsers();
      messages.forEach(msg => addMessage(msg.user, msg.text));
      
    })();
  </script>
</body>
</html>


